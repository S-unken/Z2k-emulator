<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>z2kemulator (Zurix)</title>
    <style>
        body {
            font-family: system-ui, sans-serif;
            background: #111;
            color: #eee;
            margin: 0;
            padding: 20px;
        }
        h1 { margin-top: 0; }
        .panel {
            background: #1b1b1b;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
            border: 1px solid #333;
        }
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 8px 14px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        button:disabled {
            background: #555;
            cursor: default;
        }
        input[type="file"] { color: #ccc; }
        pre {
            background: #050505;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
        .status {
            font-size: 13px;
            color: #9ca3af;
        }
    </style>
</head>
<body>
    <h1>z2kemulator (Zurix)</h1>

    <div class="panel">
        <p><strong>Load a .zrx file</strong></p>
        <input type="file" id="fileInput" accept=".zrx,.txt">
        <button id="runBtn" disabled>Run .zrx</button>
        <div class="status" id="status">No file loaded.</div>
    </div>

    <div class="panel">
        <p><strong>Parsed info</strong></p>
        <pre id="debug"></pre>
    </div>

    <script>
        const fileInput = document.getElementById('fileInput');
        const runBtn = document.getElementById('runBtn');
        const statusEl = document.getElementById('status');
        const debugEl = document.getElementById('debug');

        let zrxText = '';

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) {
                statusEl.textContent = 'No file selected.';
                runBtn.disabled = true;
                return;
            }

            const reader = new FileReader();
            reader.onload = (event) => {
                zrxText = event.target.result;
                statusEl.textContent = `Loaded: ${file.name}`;
                runBtn.disabled = false;
                debugEl.textContent = zrxText;
            };
            reader.readAsText(file);
        });

        runBtn.addEventListener('click', () => {
            if (!zrxText) return;

            try {
                const parsed = parseZRX(zrxText);
                debugEl.textContent =
                    'File structure: ' + parsed.structure + '\n' +
                    'Mode: ' + parsed.mode + '\n' +
                    'Print class: ' + parsed.printClass + '\n' +
                    'Print lines:\n' +
                    parsed.prints.map((p, i) => `${i + 1}. ${p}`).join('\n');

                openRuntimeWindow(parsed);
            } catch (err) {
                alert('Error parsing .zrx: ' + err.message);
            }
        });

        // --- Zurix parser based on your syntax manual ---

        function parseZRX(text) {
            // file structure=("program"|"game")
            const fileMatch = text.match(/<file\s+structure=\("([^"]+)"\)>\s*([\s\S]*?)<\/file>/i);
            if (!fileMatch) {
                throw new Error('Missing or invalid <file structure=("...")> ... </file>.');
            }
            const structure = fileMatch[1].trim(); // program or game
            const innerFile = fileMatch[2];

            if (structure !== 'program' && structure !== 'game') {
                throw new Error('Unknown file structure: ' + structure);
            }

            // <program> or <game>
            let modeTag = structure === 'program' ? 'program' : 'game';
            const modeMatch = innerFile.match(new RegExp('<' + modeTag + '>([\\s\\S]*?)<\\/' + modeTag + '>', 'i'));
            if (!modeMatch) {
                throw new Error('Missing <' + modeTag + '> ... </' + modeTag + '> block.');
            }
            const modeContent = modeMatch[1];

            // <top> ... </top>
            const topMatch = modeContent.match(/<top>([\s\S]*?)<\/top>/i);
            if (!topMatch) {
                throw new Error('Missing <top> ... </top>.');
            }
            const topContent = topMatch[1];

            // <bottom> ... </bottom>
            const bottomMatch = modeContent.match(/<bottom>([\s\S]*?)<\/bottom>/i);
            if (!bottomMatch) {
                throw new Error('Missing <bottom> ... </bottom>.');
            }
            const bottomContent = bottomMatch[1];

            // <preset> ... </preset> inside top
            const presetMatch = topContent.match(/<preset>([\s\S]*?)<\/preset>/i);
            if (!presetMatch) {
                throw new Error('Missing <preset> ... </preset> in <top>.');
            }
            const presetContent = presetMatch[1];

            // <print class=("still"|"type")></print> inside preset
            const classMatch = presetContent.match(/<print\s+class=\("([^"]+)"\)\s*><\/print>/i);
            if (!classMatch) {
                throw new Error('Missing <print class=("...")></print> in <preset>.');
            }
            const printClass = classMatch[1].trim();
            if (printClass !== 'still' && printClass !== 'type') {
                throw new Error('Unknown print class: ' + printClass);
            }

            // <print> ... </print> in bottom (program-exclusive tag)
            const printRegex = /<print>([\s\S]*?)<\/print>/gi;
            const prints = [];
            let m;
            while ((m = printRegex.exec(bottomContent)) !== null) {
                // trim inner text
                prints.push(m[1].trim());
            }

            if (prints.length === 0) {
                throw new Error('No <print>...</print> tags found in <bottom>.');
            }

            return {
                structure,
                mode: modeTag,
                printClass,
                prints
            };
        }

        // --- Runtime window ---

        function openRuntimeWindow(parsed) {
            const win = window.open('', '_blank', 'width=600,height=400');
            if (!win) {
                alert('Popup blocked. Allow popups for this page.');
                return;
            }

            win.document.write(`
                <!DOCTYPE html>
                <html lang="en">
                <head>
                    <meta charset="UTF-8">
                    <title>Zurix Runtime (${parsed.mode})</title>
                    <style>
                        body {
                            background: #000;
                            color: #0f0;
                            font-family: "Fira Code", monospace;
                            padding: 16px;
                            margin: 0;
                            white-space: pre-wrap;
                        }
                        .line {
                            margin-bottom: 4px;
                        }
                    </style>
                </head>
                <body>
                    <div id="output"></div>
                    <script>
                        const printClass = ${JSON.stringify(parsed.printClass)};
                        const prints = ${JSON.stringify(parsed.prints)};
                        const outputEl = document.getElementById('output');

                        function sleep(ms) {
                            return new Promise(resolve => setTimeout(resolve, ms));
                        }

                        async function run() {
                            for (const line of prints) {
                                if (printClass === 'still') {
                                    const div = document.createElement('div');
                                    div.className = 'line';
                                    div.textContent = line;
                                    outputEl.appendChild(div);
                                } else if (printClass === 'type') {
                                    const div = document.createElement('div');
                                    div.className = 'line';
                                    outputEl.appendChild(div);
                                    let current = '';
                                    for (const ch of line) {
                                        current += ch;
                                        div.textContent = current;
                                        await sleep(50); // typing speed
                                    }
                                }
                            }
                        }

                        run();
                    <\/script>
                </body>
                </html>
            `);
            win.document.close();
        }
    </script>
</body>
</html>
